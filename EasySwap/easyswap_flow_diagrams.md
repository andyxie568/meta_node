# EasySwap 业务流程图

## 1. 系统整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    EasySwap 系统架构                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   用户接口层     │    │   前端应用      │                │
│  │  (Web3/API)    │    │   (DApp)       │                │
│  └─────────────────┘    └─────────────────┘                │
│           │                       │                        │
│           └───────────┬───────────┘                        │
│                       │                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                智能合约层                               │ │
│  │  ┌─────────────────┐    ┌─────────────────┐            │ │
│  │  │ EasySwapOrderBook│    │  EasySwapVault  │            │ │
│  │  │   (订单管理)     │    │   (资产托管)    │            │ │
│  │  │                 │    │                 │            │ │
│  │  │ • 创建订单      │    │ • ETH 存储      │            │ │
│  │  │ • 取消订单      │    │ • NFT 存储      │            │ │
│  │  │ • 匹配订单      │    │ • 资产转移      │            │ │
│  │  │ • 编辑订单      │    │ • 订单编辑支持  │            │ │
│  │  └─────────────────┘    └─────────────────┘            │ │
│  │           │                       │                    │ │
│  │           └───────────┬───────────┘                    │ │
│  │                       │                                │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │                支持合约                             │ │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │ │ │
│  │  │  │OrderStorage │  │OrderValidator│  │ProtocolMgr  │ │ │ │
│  │  │  │(订单存储)   │  │(订单验证)   │  │(费用管理)   │ │ │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│                       │                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                区块链层                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │   Ethereum  │  │   ERC-721   │  │   ERC-20    │    │ │
│  │  │   (主网)    │  │  (NFT标准)  │  │  (代币标准) │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 2. 创建 List 订单流程图

```
开始
  │
  ▼
用户拥有 NFT
  │
  ▼
用户授权 Vault 合约
  │
  ▼
用户调用 makeOrders([listOrder])
  │
  ▼
OrderBook 验证订单
  ├─ 检查订单创建者
  ├─ 检查 NFT 数量 = 1
  ├─ 检查价格 > 0
  ├─ 检查过期时间
  └─ 检查 salt > 0
  │
  ▼
Vault.depositNFT()
  │
  ▼
NFT 转移到 Vault 合约
  │
  ▼
OrderBook._addOrder()
  │
  ▼
订单进入订单簿
  │
  ▼
发出 LogMake 事件
  │
  ▼
结束
```

## 3. 创建 Bid 订单流程图

```
开始
  │
  ▼
用户准备购买 NFT
  │
  ▼
用户发送 ETH + 调用 makeOrders([bidOrder])
  │
  ▼
OrderBook 验证订单
  ├─ 检查订单创建者
  ├─ 检查 NFT 数量 > 0
  ├─ 检查发送的 ETH >= 订单总价
  ├─ 检查过期时间
  └─ 检查 salt > 0
  │
  ▼
Vault.depositETH{value: price}()
  │
  ▼
ETH 转移到 Vault 合约
  │
  ▼
OrderBook._addOrder()
  │
  ▼
订单进入订单簿
  │
  ▼
发出 LogMake 事件
  │
  ▼
结束
```

## 4. 订单匹配流程图

```
开始
  │
  ▼
发现匹配的买卖订单
  │
  ▼
验证订单匹配条件
  ├─ 一个 List 订单 + 一个 Bid 订单
  ├─ 资产匹配（相同集合和 TokenID）
  ├─ 价格匹配（Bid 价格 >= List 价格）
  └─ 订单未过期且未完全填充
  │
  ▼
从 Vault 提取资产
  ├─ Vault.withdrawETH() → 提取 ETH
  └─ Vault.withdrawNFT() → 提取 NFT
  │
  ▼
计算协议费用
  │
  ▼
转移资产
  ├─ NFT 转移给买家
  ├─ ETH 转移给卖家（扣除协议费用）
  └─ 多余 ETH 返还给买家
  │
  ▼
更新订单状态
  ├─ 更新 filledAmount
  └─ 移除已完成的订单
  │
  ▼
发出 LogMatch 事件
  │
  ▼
结束
```

## 5. 订单取消流程图

```
开始
  │
  ▼
用户调用 cancelOrders([orderKeys])
  │
  ▼
验证订单所有权
  ├─ 检查订单创建者 = msg.sender
  └─ 检查订单未完全填充
  │
  ▼
从 Vault 提取资产
  ├─ 如果是 List 订单：Vault.withdrawNFT()
  └─ 如果是 Bid 订单：Vault.withdrawETH()
  │
  ▼
资产返还给用户
  │
  ▼
从订单簿移除订单
  │
  ▼
发出 LogCancel 事件
  │
  ▼
结束
```

## 6. 订单编辑流程图

```
开始
  │
  ▼
用户调用 editOrders([editDetails])
  │
  ▼
验证订单可编辑性
  ├─ 检查订单所有权
  ├─ 检查订单未完全填充
  ├─ 检查新订单参数有效性
  └─ 检查资产匹配
  │
  ▼
取消旧订单
  ├─ 从订单簿移除旧订单
  └─ 发出 LogCancel 事件
  │
  ▼
创建新订单
  ├─ 处理资产差异
  ├─ 添加新订单到订单簿
  └─ 发出 LogMake 事件
  │
  ▼
结束
```

## 7. 资产托管流程图

```
开始
  │
  ▼
资产进入 Vault
  ├─ ETH 存储：ETHBalance[orderKey] += amount
  └─ NFT 存储：NFTBalance[orderKey] = tokenId
  │
  ▼
等待订单匹配
  │
  ▼
订单匹配时
  ├─ 验证订单有效性
  ├─ 提取相应资产
  └─ 转移给交易双方
  │
  ▼
更新资产状态
  ├─ 减少 ETHBalance
  └─ 清除 NFTBalance
  │
  ▼
结束
```

## 8. 费用计算流程图

```
开始
  │
  ▼
订单匹配成功
  │
  ▼
获取成交价格
  │
  ▼
计算协议费用
  ├─ protocolFee = (fillPrice * protocolShare) / TOTAL_SHARE
  └─ sellerAmount = fillPrice - protocolFee
  │
  ▼
分配资金
  ├─ 卖家获得：sellerAmount
  ├─ 协议获得：protocolFee
  └─ 买家获得：剩余 ETH（如果有）
  │
  ▼
结束
```

## 9. 安全验证流程图

```
开始
  │
  ▼
用户发起交易
  │
  ▼
访问控制检查
  ├─ 检查调用者权限
  ├─ 检查合约状态（是否暂停）
  └─ 检查重入攻击
  │
  ▼
输入验证
  ├─ 检查参数有效性
  ├─ 检查资产所有权
  └─ 检查订单状态
  │
  ▼
业务逻辑验证
  ├─ 检查订单匹配条件
  ├─ 检查资产充足性
  └─ 检查价格合理性
  │
  ▼
执行交易
  │
  ▼
发出事件
  │
  ▼
结束
```

## 10. 错误处理流程图

```
开始
  │
  ▼
交易执行
  │
  ▼
发生错误？
  ├─ 是 → 回滚交易
  │   ├─ 恢复状态
  │   ├─ 返还资产
  │   └─ 发出错误事件
  └─ 否 → 继续执行
  │
  ▼
交易成功
  │
  ▼
发出成功事件
  │
  ▼
结束
```

## 11. 事件监听流程图

```
开始
  │
  ▼
监听合约事件
  ├─ LogMake：订单创建
  ├─ LogCancel：订单取消
  └─ LogMatch：订单匹配
  │
  ▼
解析事件数据
  ├─ 提取订单信息
  ├─ 提取交易信息
  └─ 提取价格信息
  │
  ▼
更新前端状态
  ├─ 更新订单列表
  ├─ 更新用户余额
  └─ 更新交易历史
  │
  ▼
通知用户
  │
  ▼
结束
```

## 12. 批量操作流程图

```
开始
  │
  ▼
用户发起批量操作
  ├─ makeOrders：批量创建订单
  ├─ cancelOrders：批量取消订单
  ├─ editOrders：批量编辑订单
  └─ matchOrders：批量匹配订单
  │
  ▼
遍历操作列表
  ├─ 验证每个操作
  ├─ 执行每个操作
  └─ 记录操作结果
  │
  ▼
处理失败操作
  ├─ 记录错误信息
  ├─ 继续执行其他操作
  └─ 发出错误事件
  │
  ▼
返回操作结果
  │
  ▼
结束
```

这些流程图详细展示了 EasySwap 系统的各个业务流程，帮助理解整个系统的工作原理和各个组件之间的交互关系。
