# EasySwap 系统架构图

## 系统整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    EasySwap 系统架构                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   用户接口层     │    │   前端应用      │                │
│  │  (Web3/API)    │    │   (DApp)       │                │
│  └─────────────────┘    └─────────────────┘                │
│           │                       │                        │
│           └───────────┬───────────┘                        │
│                       │                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                智能合约层                               │ │
│  │  ┌─────────────────┐    ┌─────────────────┐            │ │
│  │  │ EasySwapOrderBook│    │  EasySwapVault  │            │ │
│  │  │   (订单管理)     │    │   (资产托管)    │            │ │
│  │  │                 │    │                 │            │ │
│  │  │ • 创建订单      │    │ • ETH 存储      │            │ │
│  │  │ • 取消订单      │    │ • NFT 存储      │            │ │
│  │  │ • 匹配订单      │    │ • 资产转移      │            │ │
│  │  │ • 编辑订单      │    │ • 订单编辑支持  │            │ │
│  │  └─────────────────┘    └─────────────────┘            │ │
│  │           │                       │                    │ │
│  │           └───────────┬───────────┘                    │ │
│  │                       │                                │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │                支持合约                             │ │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │ │ │
│  │  │  │OrderStorage │  │OrderValidator│  │ProtocolMgr  │ │ │ │
│  │  │  │(订单存储)   │  │(订单验证)   │  │(费用管理)   │ │ │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│                       │                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                区块链层                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │ │
│  │  │   Ethereum  │  │   ERC-721   │  │   ERC-20    │    │ │
│  │  │   (主网)    │  │  (NFT标准)  │  │  (代币标准) │    │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘    │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 合约交互流程

### 1. 创建 List 订单流程

```
用户 → OrderBook.makeOrders() → Vault.depositNFT() → NFT.safeTransferFrom()
  ↓
OrderBook._addOrder() → 发出 LogMake 事件
```

### 2. 创建 Bid 订单流程

```
用户 → OrderBook.makeOrders() + ETH → Vault.depositETH() → 存储 ETH
  ↓
OrderBook._addOrder() → 发出 LogMake 事件
```

### 3. 订单匹配流程

```
用户 → OrderBook.matchOrders() → 验证订单 → Vault.withdrawETH()
  ↓
OrderBook → 计算费用 → 转移 ETH 给卖家 → Vault.withdrawNFT() → 转移 NFT 给买家
  ↓
OrderBook → 更新订单状态 → 发出 LogMatch 事件
```

## 数据流向图

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    用户     │    │  OrderBook  │    │    Vault    │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │ 1. 创建订单       │                   │
       ├──────────────────►│                   │
       │                   │ 2. 存入资产       │
       │                   ├──────────────────►│
       │                   │                   │
       │ 3. 匹配订单       │                   │
       ├──────────────────►│                   │
       │                   │ 4. 提取资产       │
       │                   ├──────────────────►│
       │                   │                   │
       │ 5. 转移资产       │                   │
       │◄──────────────────┤◄──────────────────┤
```

## 安全机制

```
┌─────────────────────────────────────────────────────────────┐
│                    安全防护层                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 访问控制    │  │ 重入保护    │  │ 暂停机制    │        │
│  │             │  │             │  │             │        │
│  │ • onlyOwner │  │ • nonReentrant│  │ • whenNotPaused│    │
│  │ • onlyOrderBook│  │ • 状态检查  │  │ • 紧急停止  │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 输入验证    │  │ 资产安全    │  │ 事件日志    │        │
│  │             │  │             │  │             │        │
│  │ • 参数检查  │  │ • safeTransfer│  │ • 完整记录  │        │
│  │ • 状态验证  │  │ • 余额验证  │  │ • 审计追踪  │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 状态管理

### OrderBook 状态
- `orders`: 订单存储映射
- `filledAmount`: 订单填充数量
- `protocolShare`: 协议费用比例

### Vault 状态
- `ETHBalance`: 每个订单的 ETH 余额
- `NFTBalance`: 每个订单的 NFT TokenID
- `orderBook`: 订单簿合约地址

## 事件系统

```
┌─────────────────────────────────────────────────────────────┐
│                    事件日志系统                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  LogMake: 订单创建事件                                      │
│  ├─ orderKey: 订单唯一标识                                  │
│  ├─ side: 订单类型 (List/Bid)                              │
│  ├─ maker: 订单创建者                                       │
│  ├─ nft: NFT 信息                                          │
│  ├─ price: 价格                                            │
│  └─ expiry: 过期时间                                        │
│                                                             │
│  LogCancel: 订单取消事件                                    │
│  ├─ orderKey: 订单唯一标识                                  │
│  └─ maker: 订单创建者                                       │
│                                                             │
│  LogMatch: 订单匹配事件                                     │
│  ├─ makeOrderKey: 卖方订单                                  │
│  ├─ takeOrderKey: 买方订单                                  │
│  ├─ makeOrder: 卖方订单详情                                 │
│  ├─ takeOrder: 买方订单详情                                 │
│  └─ fillPrice: 成交价格                                     │
└─────────────────────────────────────────────────────────────┘
```

这个架构图展示了 EasySwap 系统的完整结构，包括合约间的交互、数据流向、安全机制和事件系统。整个系统设计合理，模块化程度高，具有良好的可维护性和扩展性。
